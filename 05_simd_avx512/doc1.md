
---

# ç¬¬ 5 ç« ï¼šSIMD æ¶æ„çš„ç†è®ºæ¼”è¿›ä¸æ€§èƒ½æ¨¡å‹

---

## 5.1 å¼•è¨€ï¼šSIMD æ¶æ„çš„ç†è®ºæ¼”è¿›

### 5.1.1 SIMD çš„æœ¬è´¨æŠ½è±¡

**SIMD â‰  æŒ‡ä»¤é›†ï¼Œè€Œæ˜¯ä¸€ç§æ‰§è¡Œæ¨¡å‹**ï¼š

> å•æ¡æ§åˆ¶æµï¼ˆInstructionï¼‰
>
> * å¤šæ¡æ•°æ®é€šè·¯ï¼ˆData Lanesï¼‰
>   â†’ é”æ­¥ï¼ˆlockstepï¼‰æ‰§è¡Œ

ä»è®¡ç®—æ¨¡å‹ä¸Šï¼Œå®ƒæ˜¯ **DLPï¼ˆData-Level Parallelismï¼‰** çš„ç¡¬ä»¶å®ç°ï¼Œå¯¹åº”çš„æ˜¯ï¼š

* æ ‡é‡ï¼š1 instruction â†’ 1 data
* SIMDï¼š1 instruction â†’ N data
* SIMTï¼ˆGPUï¼‰ï¼š1 instruction â†’ N threadsï¼ˆå¯åˆ†æ­§ï¼‰

---

### 5.1.2 SIMD æ¼”è¿›æ—¶é—´çº¿ï¼ˆå…³é”®èŠ‚ç‚¹ï¼‰

| å¹´ä»½   | æ¶æ„       | å‘é‡å®½åº¦     | ç†è®ºæ„ä¹‰        |
| ---- | -------- | -------- | ----------- |
| 1997 | MMX      | 64-bit   | å¤šåª’ä½“æ•´æ•°å¹¶è¡Œ     |
| 1999 | SSE      | 128-bit  | æµ®ç‚¹ SIMD æ™®åŠ  |
| 2011 | AVX      | 256-bit  | YMMï¼ŒFMA åŸºç¡€  |
| 2013 | AVX2     | 256-bit  | æ•´æ•°å‘é‡å®Œæ•´      |
| 2017 | AVX512   | 512-bit  | æ©ç  + è¯­ä¹‰é©å‘½   |
| 2016 | ARM SVE  | 128â€“2048 | VL-Agnostic |
| 2021 | RISC-V V | ä»»æ„       | æ¶æ„çº§æŠ½è±¡ SIMD  |

**å…³é”®è½¬æŠ˜ç‚¹åªæœ‰ä¸¤ä¸ªï¼š**

1. **AVX512 å¼•å…¥æ©ç å¯„å­˜å™¨ï¼ˆk-regï¼‰**
2. **SVE / RISC-V V æ”¾å¼ƒâ€œå›ºå®šå‘é‡å®½åº¦â€**

---

### 5.1.3 SIMD çš„é€‚ç”¨é¢†åŸŸï¼ˆç†è®ºè§£é‡Šï¼‰

SIMD æœ€æ“…é•¿çš„é—®é¢˜ç±»å‹ï¼š

* **è§„åˆ™æ•°æ®æµ**
* **ä½æ§åˆ¶å¤æ‚åº¦**
* **é«˜ç®—æœ¯å¼ºåº¦ï¼ˆFLOPs / Byteï¼‰**

å› æ­¤å¤©ç„¶é€‚åˆï¼š

* éŸ³é¢‘ / è§†é¢‘ç¼–è§£ç ï¼ˆå·ç§¯ã€å˜æ¢ï¼‰
* å›¾åƒå¤„ç†ï¼ˆåƒç´ ç®—å­ï¼‰
* æ·±åº¦å­¦ä¹ æ¨ç†ï¼ˆGEMMã€Embeddingã€Activationï¼‰

---

## 5.2 SIMD ç¡¬ä»¶ç†è®ºåŸºç¡€

---

### 5.2.1 å‘é‡å¯„å­˜å™¨æ¨¡å‹

#### å›ºå®šå®½åº¦ï¼ˆAVX2 / AVX512ï¼‰

* AVX2ï¼š256-bit = 8 Ã— float
* AVX512ï¼š512-bit = 16 Ã— float

ğŸ‘‰ **è½¯ä»¶å¿…é¡»æ˜¾å¼å‡è®¾å®½åº¦**

```text
for i in range(0, N, 16):
    process(v[i : i+16])
```

---

#### å¯å˜å®½åº¦ï¼ˆARM SVE / RISC-V Vï¼‰

* ç¼–è¯‘æœŸä¸çŸ¥é“å‘é‡é•¿åº¦
* é€šè¿‡ predicate æ§åˆ¶ active lanes

```c
while (svptest_any(p)) {
    svfloat32_t v = svld1(p, ptr);
    ...
    p = svwhilelt(...)
}
```

ğŸ‘‰ **æ¶æ„é¦–æ¬¡å°†â€œå‘é‡é•¿åº¦â€ä» ISA ä¸­æŠ½è±¡æ‰**

---

### 5.2.2 æ•°æ®å¹¶è¡Œåº¦è®¡ç®—æ¨¡å‹

ä»¥ float ä¸ºä¾‹ï¼š

| æ¶æ„     | å‘é‡å®½åº¦    | å¹¶è¡Œåº¦ |
| ------ | ------- | --- |
| SSE    | 128-bit | 4   |
| AVX2   | 256-bit | 8   |
| AVX512 | 512-bit | 16  |
| SVE    | VL/32   | åŠ¨æ€  |

---

### 5.2.3 SIMD æ‰§è¡Œçš„å…³é”®ç¡¬ä»¶ç»„ä»¶

#### 1ï¸âƒ£ Load / Store å•å…ƒ

* å¯¹é½è®¿é—®ï¼ˆ64B cache lineï¼‰
* Misaligned load = é¢å¤– Âµops

> **ç†è®ºåŸåˆ™ï¼šè®¿å­˜ â‰  è®¡ç®—ï¼ŒSIMD å¾ˆå®¹æ˜“è¢«å†…å­˜æ‰“çˆ†**

---

#### 2ï¸âƒ£ å‘é‡ ALU

* Add / Mul / FMA
* å¤šæµæ°´çº¿å¹¶è¡Œ

---

#### 3ï¸âƒ£ æ©ç æ‰§è¡Œï¼ˆAVX512 çš„é©å‘½ï¼‰

```c
_mm512_mask_add_ps(dst, mask, a, b);
```

* é¿å…åˆ†æ”¯
* å…è®¸éƒ¨åˆ† lane ç©ºè½¬

ğŸ‘‰ **è¿™æ˜¯ SIMD èƒ½å¤„ç†å¤æ‚æ§åˆ¶çš„å…³é”®**

---

#### 4ï¸âƒ£ Gather / Scatter

* éè¿ç»­å†…å­˜è®¿é—®
* æœ¬è´¨æ˜¯â€œå¤šæ¬¡ scalar load çš„å‘é‡å°è£…â€

âš ï¸ **ç†è®ºä¸Šæ˜¯ SIMD æœ€æ…¢çš„æŒ‡ä»¤ç±»åˆ«**

---

### 5.2.4 SIMD ç‰ˆ Amdahl å®šå¾‹

ç»å…¸ Amdahlï¼š

[
Speedup = \frac{1}{(1-P) + \frac{P}{N}}
]

SIMD æ‰©å±•ï¼š

* Pï¼šå¯å‘é‡åŒ–æ¯”ä¾‹
* Nï¼šå‘é‡å®½åº¦
* ä¸²è¡Œéƒ¨åˆ†ï¼šåˆ†æ”¯ã€å°¾éƒ¨å¤„ç†ã€æ ‡é‡è°ƒç”¨

ğŸ‘‰ **N è¶Šå¤§ï¼Œè¾¹é™…æ”¶ç›Šè¶Šä½**

---

## 5.3 è‡ªåŠ¨å‘é‡åŒ–çš„ç†è®ºæ¡ä»¶

---

### 5.3.1 è‡ªåŠ¨å‘é‡åŒ–çš„æŠ½è±¡æµç¨‹

ç¼–è¯‘å™¨åšçš„ä¸æ˜¯â€œèƒ½ä¸èƒ½ vectorizeâ€ï¼Œè€Œæ˜¯ï¼š

1. æ„å»º **ä¾èµ–å›¾ï¼ˆDependence Graphï¼‰**
2. æ„å»º **å‘é‡ç‰ˆæœ¬ IR**
3. ç”¨ **Cost Model ä¼°ç®— cycle**
4. é€‰æ‹©æ ‡é‡ or å‘é‡

---

### 5.3.2 å¿…è¦æ¡ä»¶ï¼ˆç†è®ºåŸå› ï¼‰

| æ¡ä»¶                        | ç†è®ºè§£é‡Š           |
| ------------------------- | -------------- |
| æ—  loop-carried dependency | å¦åˆ™ç ´å lockstep  |
| è¿ç»­å†…å­˜                      | SIMD Load æ‰æœ‰æ„ä¹‰ |
| æ— åˆ«å                       | ç¼–è¯‘å™¨æ‰èƒ½é‡æ’        |
| è¿­ä»£æ¬¡æ•°è¶³å¤Ÿå¤§                   | amortize setup |

---

### 5.3.3 è‡ªåŠ¨å‘é‡åŒ–å¤±è´¥çš„æ ¹æœ¬åŸå› 

* **Alias åˆ†æå¤±è´¥**ï¼ˆæœ€å¸¸è§ï¼‰
* å‡½æ•°è°ƒç”¨é˜»æ–­ SSA
* åˆ†æ”¯å¯¼è‡´ mask ä»£ä»·é«˜
* Gather æˆæœ¬ > æ ‡é‡

ğŸ‘‰ **è‡ªåŠ¨å‘é‡åŒ–ä¸æ˜¯â€œèƒ½åŠ›é—®é¢˜â€ï¼Œè€Œæ˜¯â€œæ”¶ç›Šé—®é¢˜â€**

---

## 5.4 æ‰‹åŠ¨ SIMDï¼šIntrinsics ç†è®ºæ¡†æ¶

---

### 5.4.1 Intrinsics çš„æŠ½è±¡åœ°ä½

Intrinsics = **ISA çš„ç»“æ„åŒ–è¯­ä¹‰æ˜ å°„**

* éæ±‡ç¼–
* é C++
* æ˜¯â€œåŠæŠ½è±¡ ISAâ€

---

### 5.4.2 ä¸‰å¤§è®¾è®¡åŸåˆ™ï¼ˆç†è®ºï¼‰

#### 1ï¸âƒ£ å¯¹é½åŸåˆ™

* å¯¹é½ load = 1 Âµop
* éå¯¹é½ load = å¤š Âµop

---

#### 2ï¸âƒ£ Mask æ›¿ä»£ Branch

```c
if (cond) x += y;
```

â†’

```c
_mm512_mask_add_ps(...)
```

ğŸ‘‰ æ¶ˆç­æ§åˆ¶ç›¸å…³æ€§

---

#### 3ï¸âƒ£ Loop Peeling

* å‘é‡ä¸»å¾ªç¯
* æ ‡é‡å°¾éƒ¨

---

### 5.4.3 SIMD å³°å€¼æ€§èƒ½æ¨¡å‹

[
Peak = Cores Ã— Freq Ã— Lanes Ã— Ops
]

ä¾‹ï¼šXeon AVX512

* 16 lanes
* 2 Ã— FMA
* â†’ 32 FLOPs / cycle / core

---

## 5.5 AVX2 vs AVX512 vs SVEï¼šISA ç†è®ºå¯¹æ¯”

| ç‰¹æ€§   | AVX2 | AVX512 | SVE |
| ---- | ---- | ------ | --- |
| å®½åº¦   | å›ºå®š   | å›ºå®š     | å¯å˜  |
| æ©ç    | âŒ    | âœ…      | âœ…   |
| åŠŸè€—   | ä½    | é«˜ï¼ˆé™é¢‘ï¼‰  | å¯æ§  |
| å¯ç§»æ¤æ€§ | ä¸­    | ä½      | é«˜   |
| æœªæ¥æ€§  | å¼±    | æœ‰é™     | æå¼º  |

ğŸ‘‰ **SVE / RISC-V V æ˜¯â€œç¼–ç¨‹æ¨¡å‹å‡çº§â€ï¼Œä¸æ˜¯å•çº¯åŠ å®½**

---

## 5.6 æ‰‹åŠ¨ vs è‡ªåŠ¨çš„å†³ç­–æ¨¡å‹

### 5.6.1 ç†è®ºåˆ¤æ–­å‡†åˆ™

* è‡ªåŠ¨ â‰¥ 90% å³°å€¼ â†’ ä¸åŠ¨
* < 80% ä¸” loop æ ¸å¿ƒ â†’ æ‰‹åŠ¨
* Gather / åˆ†æ”¯ â†’ å¿…é¡»æ‰‹åŠ¨

---

### 5.6.2 å®é™…å·¥ä¸šç­–ç•¥

> **80% åœºæ™¯é è‡ªåŠ¨
> 20% çƒ­ç‚¹é æ‰‹åŠ¨**

---

## 5.7 SIMD + å¤šçº¿ç¨‹èåˆç†è®º

---

### 5.7.1 OpenMP SIMD çš„è¯­ä¹‰

```c
#pragma omp simd
```

= å‘Šè¯‰ç¼–è¯‘å™¨ï¼š

> **æˆ‘ä¿è¯æ— ä¾èµ–ï¼Œä½ å¯ä»¥å¤§èƒ† vectorize**

---

### 5.7.2 Roofline Model

* æ¨ªè½´ï¼šç®—æœ¯å¼ºåº¦
* çºµè½´ï¼šæ€§èƒ½
* SIMD â†’ æé«˜è®¡ç®—å±‹é¡¶
* Cache / DRAM â†’ å†³å®šèƒ½å¦è§¦é¡¶

---

## 5.8 çœŸå®ä¸–ç•Œæ¡ˆä¾‹ï¼ˆç†è®ºæ‹†è§£ï¼‰

---

### FFmpegï¼ˆAVX512ï¼‰

* H.264 IDCT
* SIMD å±•å¼€ 8Ã—8 block
* å‡å°‘åˆ†æ”¯ + æ•°æ®é‡æ’

ğŸ‘‰ ç†è®ºåŠ é€Ÿ = block å¹¶è¡Œåº¦ Ã— lane æ•°

---

### TorchServe / Embedding

* æŸ¥è¡¨ + FMA
* æ‰‹åŠ¨ SIMD åˆå¹¶ lookup
* å‡å°‘ L1 miss

---

## 5.9 å±€é™æ€§ä¸æœªæ¥

### å±€é™

* åˆ†æ”¯å¯†é›†
* ç¨€ç–æ•°æ®
* Pointer chasing

---

### æœªæ¥æ–¹å‘

* **RISC-V V 1.0**
* å‘é‡é•¿åº¦é€æ˜
* ç¼–è¯‘å™¨ä¸­å¿ƒåŒ–ä¼˜åŒ–

---

## 5.10 å°ç»“

> SIMD æ˜¯ **â€œæŠŠå¹¶è¡Œæ€§ç¡¬ç¼–ç è¿› ALU çš„æè‡´å½¢æ€â€**ã€‚
> çœŸæ­£çš„é«˜æ‰‹ä¸æ˜¯â€œä¼šå†™ intrinsicsâ€ï¼Œè€Œæ˜¯èƒ½ **ç”¨æ¶æ„æ¨¡å‹åˆ¤æ–­æ˜¯å¦å€¼å¾—å†™**ã€‚

---

# GitHub ä¸å­¦ä¹ èµ„æºï¼ˆç²¾é€‰ï¼‰

## å®˜æ–¹ / æƒå¨

* Intel Intrinsics Guide
  [https://github.com/intel/intrinsics-guide](https://github.com/intel/intrinsics-guide)

* ARM SVE æ–‡æ¡£
  [https://developer.arm.com/documentation/102476](https://developer.arm.com/documentation/102476)

* RISC-V V Spec
  [https://github.com/riscv/riscv-v-spec](https://github.com/riscv/riscv-v-spec)

---

## ç¼–è¯‘å™¨ä¸å·¥å…·

* LLVM Vectorizer
  [https://github.com/llvm/llvm-project](https://github.com/llvm/llvm-project)

* Compiler Explorer
  [https://godbolt.org](https://godbolt.org)

---

## ç»å…¸ä¹¦ç± / è®ºæ–‡

* **Computer Architecture: A Quantitative Approach**
* **What Every Programmer Should Know About Vectorization**

---

## å­¦ä¹ è§†é¢‘ï¼ˆå¼ºçƒˆæ¨èï¼‰

* Intel SIMD Deep Diveï¼ˆYouTubeï¼‰
* ARM SVE Programmingï¼ˆARM å®˜æ–¹ï¼‰
* RISC-V Vector Extension Workshop

---

